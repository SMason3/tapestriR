---
title: "DNA Analysis"
output:
  html_document:
    df_print: paged
    toc: true
editor_options: 
  chunk_output_type: console
---


```{r include=FALSE}

library(TapestriR)
require(rhdf5)
library(tidyverse)
library(ggplot2)
library(plotly)
require(patchwork)

# umap library
library(uwot)

#normalization 
library(SciViews)

# clustering
require(scran)


```

### Load data

to do:
* meta data summary? 
* filter options identical to insights
* annotate variant and amplicons so I can easily select

```{r load data, cache=TRUE}

filename <- "~/Google Drive/launches/r_package/TapestriR/data/PE11.cells.loom"

variants = read_loom(filename,min_mutation_rate = 0.1)

filtered_variants = filter_variants2(variants)
vaf=round(filtered_variants@data_layers$AD/filtered_variants@data_layers$DP, 3)
vaf[is.na(vaf)] <- 0
filtered_variants = add_data_layer(filtered_variants,'VAF',vaf)

```

### Cluster SNV

clustering by kmeans and louvain on umap projection and raw features

```{r cluster snv, cache=TRUE}

##################
# do demension reduction and clustering a few different ways
##################

#dimensional reduction using umap
set.seed(111)
umap_values <- umap(filtered_variants$data_layers$VAF, scale=TRUE, metric="manhattan", init="laplacian", pca=20) 

umap_layer = tibble(    
      x = umap_values[,1],
      y = umap_values[,2]
)

filtered_variants = add_analysis_layer(assay = filtered_variants, layer_name = 'umap_vaf',data = umap_layer)
  
######
# Hold all the different customer labels in a single structure
#####
cluster_by = filtered_variants@analysis_layers$umap_vaf
clusters = tibble(cell_id=filtered_variants@cell_annotations$cell_id)

#### do the clustering

for(i in 2:5) {
  kmean_values <- kmeans(cluster_by, i ,iter.max=500)
  clusters[[paste0('umap.kmean.cluster.',i)]] = as_factor(kmean_values$cluster)

  kmean_values <- kmeans(cluster_by, i ,iter.max=500)
  clusters[[paste0('feature.kmean.cluster.',i)]] = as_factor(kmean_values$cluster)

}

graph_values <- buildSNNGraph(t(cluster_by), k=150)
louvain_clust <- igraph::cluster_louvain(graph_values)$membership

clusters = clusters %>% mutate(
  umap.louvain.cluster = as_factor(louvain_clust))

graph_values <- buildSNNGraph(t(cluster_by), k=150)
louvain_clust <- igraph::cluster_louvain(graph_values)$membership

clusters = clusters %>% mutate(
  features.louvain.cluster = as_factor(louvain_clust))

#############
## Add cluster labels to analysis data structure
#############
filtered_variants = filtered_variants %>% add_analysis_layer(
                                           layer_name =   'umap_vaf_clusters',
                                           data = clusters[,-1])


```

#### plot UMAP and Clusters

plot all the different clusters on the same umap projection

```{r fig.width = 12, fig.height = 8}

p  = tapestri_scatterplot(
                 x = filtered_variants@analysis_layers$umap_vaf$x, 
                 y= filtered_variants@analysis_layers$umap_vaf$y, 
                 color_by = filtered_variants@analysis_layers$umap_vaf_clusters$umap.kmean.cluster.2)
p = p + umap_theme() + ggtitle('umap_vaf_clusters')



q  = tapestri_scatterplot(
                 x = filtered_variants@analysis_layers$umap_vaf$x, 
                 y= filtered_variants@analysis_layers$umap_vaf$y, 
                 color_by = filtered_variants@data_layers$AD)
q = q + umap_theme() + ggtitle('umap_vaf_clusters')

p + q

```
