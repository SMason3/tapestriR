---
title: "DNA Analysis"
output:
  html_document:
    df_print: paged
    toc: true
editor_options: 
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{DNA Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r include=FALSE}

library(TapestriR)

#packages needed for visualization 
library(tidyverse)
library(ggplot2)
library(plotly)
library(patchwork)


#packages needed for analysis

packages <- c("factoextra",  "NbClust", 'scran', 'uwot')

for(i in 1:length(packages)) {
  package = packages[i]
  if (!requireNamespace(package, quietly = TRUE))
    install.packages(package)

  require(package=package, character.only=TRUE)
}


ASSAY_NAME_VARIANT = 'dna'
ASSAY_NAME_READ_COUNT = 'cnv'
ASSAY_NAME_PROTEIN = 'protein'



```

### Load data

to do:
* meta data summary? 
* filter options identical to insights
* annotate variant and amplicons so I can easily select

```{r load data, cache=TRUE}

filename <- system.file("extdata", "PE11.cells.loom", package = "TapestriR")

variants = read_loom(filename,min_mutation_rate = 0.005)

filtered_variants = filter_variants(variants)
vaf=round(filtered_variants@data_layers$AD/filtered_variants@data_layers$DP, 3)
vaf[is.na(vaf)] <- 0
filtered_variants = add_data_layer(filtered_variants,'VAF',vaf)

```


### Demension Reduction

```{r}

#dimensional reduction using umap
set.seed(111)
umap_values <- umap(filtered_variants$data_layers$VAF, scale=TRUE, metric="manhattan", init="laplacian", pca=20) 

umap_layer = tibble(    
      x = umap_values[,1],
      y = umap_values[,2]
)

filtered_variants = add_analysis_layer(assay = filtered_variants, layer_name = 'umap_vaf',data = umap_layer)


```

### Plot the data

```{r}

p = ggplot(filtered_variants@analysis_layers$umap_vaf)
p = p + geom_point(aes(x = x, y = y), alpha = 0.5, size=0.8)
p = p + theme_bw()
p

```


### Figure out how many clusters?

This is not a trivial problem. Its left to user to explore the data. Here are a few examples on determining the number of clusters in your data. 

```{r num_clusters, warning=FALSE, cache=TRUE}

cluster_on = filtered_variants$data_layers$VAF

# Elbow method
elbow = fviz_nbclust(cluster_on, kmeans, method = "wss") +

  labs(subtitle = "Elbow method")

# Silhouette method
silhouette = fviz_nbclust(cluster_on, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
# set.seed(123)
# gap_stat = fviz_nbclust(cluster_on, kmeans, nstart = 25,  method = "gap_stat", nboot = 5)+
#   labs(subtitle = "Gap statistic method")


(elbow + silhouette)
# / 
#   (gap_stat + plot_spacer())

```


### Cluster SNV

clustering by kmeans and louvain on umap projection and raw features

```{r cluster_snv}
  

#### Hold all the different customer labels in a single structure
cluster_by = filtered_variants@analysis_layers$umap_vaf
clusters = list()

#### do the clustering

for(i in 2:5) {
  kmean_values <- kmeans(cluster_by, i ,iter.max=500)
  clusters[[paste0('umap.kmean.cluster.',i)]] = as_factor(kmean_values$cluster)

  kmean_values <- kmeans(cluster_by, i ,iter.max=500)
  clusters[[paste0('feature.kmean.cluster.',i)]] = as_factor(kmean_values$cluster)

}

graph_values <- buildSNNGraph(t(cluster_by), k=150)
louvain_clust <- igraph::cluster_louvain(graph_values)$membership

clusters[['umap.louvain.cluster']] = as_factor(louvain_clust)

graph_values <- buildSNNGraph(t(cluster_by), k=150)
louvain_clust <- igraph::cluster_louvain(graph_values)$membership

clusters[['features.louvain.cluster']] = as_factor(louvain_clust)



#### Add cluster labels to analysis data structure
filtered_variants = add_analysis_layer( assay = filtered_variants,
                                           layer_name  = 'umap_vaf_clusters',
                                           data = as_tibble(clusters))


```

#### plot UMAP and Clusters

plot all the different clusters on the same umap projection

```{r fig.width = 12, fig.height = 8}

p  = tapestri_scatterplot(
                 x = filtered_variants@analysis_layers$umap_vaf$x, 
                 y= filtered_variants@analysis_layers$umap_vaf$y, 
                 color_by = filtered_variants@analysis_layers$umap_vaf_clusters$umap.kmean.cluster.2)
p = p + umap_theme() + ggtitle('umap_vaf_clusters')



q  = tapestri_scatterplot(
                 x = filtered_variants@analysis_layers$umap_vaf$x, 
                 y= filtered_variants@analysis_layers$umap_vaf$y, 
                 color_by = filtered_variants@data_layers$AD)
q = q + umap_theme() + ggtitle('umap_vaf_clusters')

p + q

```
